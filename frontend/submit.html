<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="config.js"></script>
  <title>Submit Reflection</title>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
<div class="fixed top-4 left-4 space-x-2 z-50">
  <a href="dashboard.html" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 shadow">
    Dashboard
  </a>
  <button onclick="history.back()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 shadow">
    Back
  </button>
</div>

  <div class="bg-white p-8 rounded-xl shadow-md w-full max-w-md space-y-6">
    <h2 class="text-2xl font-bold text-gray-800 text-center">Submit Reflection</h2>

<form id="submit-form" class="space-y-4" enctype="multipart/form-data">
  <select id="chapter-id" class="w-full p-3 border rounded-lg" required></select>

  <input type="file" id="video-file" accept="video/*" class="w-full p-3 border rounded-lg" required />

  <textarea id="summary" rows="5" placeholder="Optional summary..." class="w-full p-3 border rounded-lg"></textarea>

  <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">Submit</button>
</form>



    <button onclick="logout()" class="w-full bg-red-500 text-white py-2 rounded-lg hover:bg-red-600">Logout</button>
  </div>

  <script>

  const chapterSelect = document.getElementById("chapter-id");

  // ✅ Load chapter list from backend
  async function loadChapters() {
    try {
      const res = await fetch(`${API_BASE}/chapters`);
      const chapters = await res.json();

      chapters.forEach(chap => {
        const opt = document.createElement("option");
        opt.value = chap.id;
        opt.textContent = chap.name;
        chapterSelect.appendChild(opt);
      });
    } catch (err) {
      alert("Failed to load chapters.");
      console.error("Chapter load error:", err);
    }
  }

  loadChapters();

  // ✅ Submit reflection
  document.getElementById("submit-form").addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = new FormData();
    formData.append("chapter_id", chapterSelect.value);
    formData.append("video_file", document.getElementById("video-file").files[0]);
    formData.append("text_summary", document.getElementById("summary").value);

    const res = await fetch(`${API_BASE}/submit-reflection`, {
      method: "POST",
      headers: {
        Authorization: `Bearer ${localStorage.getItem("token")}`
      },
      body: formData
    });

    const text = await res.text();
    try {
      const data = JSON.parse(text);
      if (res.ok) {
        alert("Reflection submitted successfully!");
        document.getElementById("submit-form").reset();
      } else if (res.status === 400 && data.detail.includes("already submitted")) {
        alert("You’ve already submitted for this chapter.");
      } else if (res.status === 429) {
        alert("You've reached the reflection limit for today.");
      } else {
        alert(data.detail || "Submission failed.");
      }
    } catch (err) {
      console.error("Unexpected response:", text);
      alert("Unexpected error. Please try again.");
    }
  });

  </script>

</body>
</html>
